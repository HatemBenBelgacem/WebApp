# --- Stage 1: Build Stage ---
FROM rust:1.75-slim-bookworm AS builder

# Installiere notwendige System-Abhängigkeiten
RUN apt-get update && apt-get install -y \
    pkg-config \
    libssl-dev \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Installiere das Dioxus CLI
RUN cargo install dioxus-cli --version 0.5.0

# Arbeitsverzeichnis erstellen
WORKDIR /usr/src/app

# Kopiere die Manifest-Dateien für effizientes Caching der Abhängigkeiten
COPY Cargo.toml Cargo.lock Dioxus.toml ./

# Erstelle einen Dummy-Source-Ordner, um Abhängigkeiten vorab zu kompilieren
RUN mkdir src && echo "fn main() {}" > src/main.rs
RUN dx build --release --platform fullstack

# Jetzt den echten Code kopieren
COPY . .

# Eigentlicher Build-Vorgang
# --platform fullstack baut sowohl das Backend als auch das Frontend (WASM)
RUN dx build --release --platform fullstack

# --- Stage 2: Runtime Stage ---
FROM debian:bookworm-slim

# Installiere OpenSSL (wichtig für PostgreSQL/Verbindungen) & Zertifikate
RUN apt-get update && apt-get install -y \
    ca-certificates \
    libssl3 \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Kopiere das ausführbare Backend aus der Builder-Stage
# Der Pfad kann variieren, meist: target/release/[projektname]
COPY --from=builder /usr/src/app/target/release/webapp /app/server

# Kopiere die generierten Assets (WASM, CSS, etc.)
COPY --from=builder /usr/src/app/dist /app/dist

# Railway nutzt die PORT Umgebungsvariable
ENV PORT=8080
EXPOSE 8080

# Starte die Anwendung
CMD ["/app/server"]